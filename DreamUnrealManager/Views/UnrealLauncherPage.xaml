<Page
    x:Class="DreamUnrealManager.Views.UnrealLauncherPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:DreamUnrealManager.ViewModels"
    xmlns:models="using:DreamUnrealManager.Models"
    xmlns:helpers="using:DreamUnrealManager.Helpers"
    mc:Ignorable="d">

    <Page.DataContext>
        <vm:UnrealLauncherViewModel />
    </Page.DataContext>

    <Page.Resources>
        <Style x:Key="EngineItemContainerStyle" TargetType="ListViewItem">
            <Setter Property="Margin" Value="4" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="VerticalContentAlignment" Value="Stretch" />
            <Setter Property="Background" Value="Transparent" />
        </Style>

        <helpers:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </Page.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <TextBlock Text="引擎管理器"
                   FontSize="28"
                   FontWeight="SemiBold"
                   Margin="20" />
        
        <Border Grid.Row="1"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,1"
                Padding="20,12">
            <Grid ColumnSpacing="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 搜索 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                    <AutoSuggestBox Grid.Column="0" Width="360"
                                    PlaceholderText="搜索：名称/路径/版本"
                                    Text="{x:Bind ViewModel.SearchText, Mode=TwoWay}"
                                    TextChanged="SearchBox_TextChanged" />
                
                    <ComboBox Grid.Column="1" Width="200"
                              ItemsSource="{x:Bind ViewModel.SortOptions}"
                              SelectedItem="{x:Bind ViewModel.SelectedSortOption, Mode=TwoWay}" />
                    <Button Grid.Column="2" Content="清除" Click="ClearFilters_Click" />
                </StackPanel>
                

                <!-- 右侧按钮 + 布局切换 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
                    <Button Click="AddEngine_Click">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE710;" />
                            <TextBlock Text="添加引擎" />
                        </StackPanel>
                    </Button>
                    <Button Click="AutoDetect_Click">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE71E;" />
                            <TextBlock Text="自动检测" />
                        </StackPanel>
                    </Button>
                    <Button Click="RefreshAll_Click">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE72C;" />
                            <TextBlock Text="刷新全部" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="2"
              HorizontalAlignment="Stretch">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- 主列表 -->
            <ListView x:Name="EnginesList"
                      ItemsSource="{x:Bind ViewModel.FilteredEngines, Mode=OneWay}"
                      IsItemClickEnabled="False"
                      SelectionMode="None"
                      HorizontalContentAlignment="Center"
                      ItemContainerStyle="{StaticResource EngineItemContainerStyle}">

                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical"
                                    Spacing="8"
                                    Margin="0,4,0,4" />
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>

                <!-- 项目模板 -->
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:UnrealEngineInfo">
                        <Border CornerRadius="10"
                                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                Height="150">

                            <Grid ColumnSpacing="12" HorizontalAlignment="Stretch">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- 引擎图标 -->
                                <Border Grid.Column="0"
                                        CornerRadius="0, 0, 0, 0"
                                        Width="150" Height="150">
                                    <Image Source="../Assets/UnrealIcon.png" />
                                </Border>


                                <!-- 左侧信息块 -->
                                <StackPanel Grid.Column="1" Spacing="6" Padding="15">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <!-- Engine Name -->
                                        <TextBlock Text="{x:Bind DisplayName}"
                                                   FontSize="25" FontWeight="SemiBold" />
                                        <Border Background="{ThemeResource AccentFillColorSecondaryBrush}"
                                                Padding="6, 2"
                                                CornerRadius="6"
                                                VerticalAlignment="Center"
                                                Visibility="{x:Bind IsSourceBuild, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <TextBlock Text="源码版"
                                                       Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                                                       Style="{ThemeResource CaptionTextBlockStyle}" />
                                        </Border>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <TextBlock Text="{x:Bind GetDisplayVersion()}" Opacity="0.85" />
                                        <TextBlock Text="•" Opacity="0.5" />
                                        <TextBlock Text="{x:Bind StatusText}" Opacity="0.85" />
                                    </StackPanel>
                                    <TextBlock Text="{x:Bind EnginePath}"
                                               Opacity="0.75" TextTrimming="CharacterEllipsis" />
                                </StackPanel>

                                <!-- 右侧操作区 -->
                                <StackPanel Grid.Column="2"
                                            Padding="15"
                                            Orientation="Horizontal" Spacing="8"
                                            VerticalAlignment="Center">

                                    <Button Click="OpenEditor_Click" Tag="{x:Bind EnginePath}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xEA64;" />
                                            <TextBlock Text="启动引擎" />
                                        </StackPanel>
                                    </Button>

                                    <Button Click="OpenFolder_Click" Tag="{x:Bind EnginePath}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xEC51;" />
                                            <TextBlock Text="打开路径" />
                                        </StackPanel>
                                    </Button>

                                    <Button Click="OpenFolder_Click" Tag="{x:Bind EnginePath}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE62F;" />
                                            <TextBlock Text="复制路径" />
                                        </StackPanel>
                                    </Button>

                                    <Button Click="RefreshOne_Click" Tag="{x:Bind EnginePath}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE72C;" />
                                            <TextBlock Text="刷新" />
                                        </StackPanel>
                                    </Button>
                                    <Button Click="Remove_Click" Tag="{x:Bind EnginePath}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE74D;" />
                                            <TextBlock Text="删除" />
                                        </StackPanel>
                                    </Button>

                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <!-- 空态 -->
            <StackPanel x:Name="EmptyState" Visibility="Collapsed"
                        VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="8">
                <TextBlock Text="尚未添加任何 Unreal Engine" FontSize="22" FontWeight="SemiBold" />
                <TextBlock Text="点击左上角“添加引擎”选择 UE 根目录（含 Engine 文件夹）" Opacity="0.8" />
            </StackPanel>
        </Grid>


        <!-- 状态栏 -->
        <InfoBar Grid.Row="3"
                 IsOpen="True"
                 IsIconVisible="False"
                 Severity="Informational"
                 Message="{x:Bind ViewModel.StatusText, Mode=OneWay}" />
    </Grid>
</Page>